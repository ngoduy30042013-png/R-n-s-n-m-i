<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R·∫Øn SƒÉn M·ªìi (Snake) - C√≥ Firebase & AI</title>
    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Thi·∫øt l·∫≠p font Inter */
        html { font-family: 'Inter', sans-serif; }
        /* ƒê·∫£m b·∫£o canvas c√≥ k√≠ch th∆∞·ªõc c·ªë ƒë·ªãnh trong grid */
        #gameCanvas {
            background-color: #2d3748; /* M√†u n·ªÅn t·ªëi cho game */
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* ·∫®n thanh cu·ªôn n·∫øu c√≥ */
        body { overflow-x: hidden; }
        /* ƒê·∫∑t messageBox bao ph·ªß Canvas */
        #gameContainer {
            position: relative;
        }
    </style>
    <!-- C·∫•u h√¨nh Tailwind cho m√†u s·∫Øc v√† bo g√≥c -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'snake-green': '#48bb78',
                        'food-red': '#f56565',
                        'dark-bg': '#1a202c',
                        'light-card': '#2d3748',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-dark-bg text-white min-h-screen p-4 flex flex-col items-center justify-center">

    <div class="w-full max-w-5xl flex flex-col lg:flex-row gap-6">

        <!-- C·ªôt Game Ch√≠nh -->
        <div class="flex flex-col items-center flex-grow">
            <h1 class="text-4xl font-extrabold mb-4 text-snake-green">R·∫Øn SƒÉn M·ªìi</h1>

            <!-- Hi·ªÉn th·ªã th√¥ng tin ng∆∞·ªùi d√πng -->
            <div id="user-info" class="mb-4 text-sm text-gray-400">ƒêang t·∫£i...</div>

            <!-- Khung tr√≤ ch∆°i v√† ƒëi·ªÉm s·ªë -->
            <div id="gameContainer" class="bg-light-card p-6 rounded-xl shadow-2xl w-full max-w-md">
                <div class="flex justify-between items-center mb-4">
                    <p class="text-xl font-semibold">ƒêi·ªÉm: <span id="score" class="text-yellow-400">0</span></p>
                    <button id="startButton" class="bg-snake-green hover:bg-green-600 text-dark-bg font-bold py-2 px-4 rounded-lg transition duration-200 shadow-md">B·∫Øt ƒê·∫ßu</button>
                </div>
                <!-- Canvas Game -->
                <canvas id="gameCanvas" width="400" height="400" class="w-full max-w-full aspect-square"></canvas>

                <!-- M√†n h√¨nh Game Over / H∆∞·ªõng d·∫´n -->
                <!-- messageBox n·∫±m tuy·ªát ƒë·ªëi so v·ªõi gameContainer -->
                <div id="messageBox" class="absolute inset-0 bg-dark-bg bg-opacity-90 rounded-xl flex items-center justify-center hidden">
                    <div class="text-center p-6 bg-light-card rounded-xl shadow-lg w-11/12 max-w-xs">
                        <p id="messageText" class="text-2xl font-bold mb-4">Nh·∫•n B·∫ÆT ƒê·∫¶U ƒë·ªÉ ch∆°i!</p>
                        <p class="text-sm text-gray-400">D√πng c√°c ph√≠m M≈©i t√™n ho·∫∑c WASD ƒë·ªÉ ƒëi·ªÅu khi·ªÉn.</p>

                        <!-- Gemini Feature Integration -->
                        <button id="generateCommentaryButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-xl transition duration-200 shadow-lg mt-4 hidden">
                            Nh·∫≠n B√¨nh Lu·∫≠n Score ‚ú®
                        </button>
                        <div id="loadingIndicator" class="mt-4 hidden text-sm text-blue-400 font-semibold">ƒêang t·∫°o b√¨nh lu·∫≠n...</div>
                        <div id="aiCommentary" class="mt-4 p-3 bg-gray-800 rounded-lg text-sm text-left hidden">
                            <p class="font-semibold text-blue-400">B√¨nh lu·∫≠n c·ªßa Gemini:</p>
                            <p id="commentaryText" class="mt-1 text-gray-300 italic"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- C·ªôt ƒêi·ªÉm Cao (High Scores) -->
        <div class="w-full lg:w-96 bg-light-card p-6 rounded-xl shadow-2xl">
            <h2 class="text-2xl font-bold mb-4 text-center text-red-400">B·∫£ng X·∫øp H·∫°ng</h2>
            <div id="highScoresList" class="space-y-2">
                <!-- ƒêi·ªÉm cao s·∫Ω ƒë∆∞·ª£c ch√®n ·ªü ƒë√¢y -->
                <p class="text-center text-gray-400">ƒêang t·∫£i ƒëi·ªÉm cao...</p>
            </div>
        </div>

    </div>

    <!-- Script Game v√† Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, limit, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Thi·∫øt l·∫≠p Debug Logging cho Firestore
        setLogLevel('Debug');

        // --- C·∫•u h√¨nh Firebase (S·ª≠ d·ª•ng bi·∫øn to√†n c·ª•c t·ª´ m√¥i tr∆∞·ªùng Canvas) ---
        // Khi xu·∫•t ra ngo√†i, c√°c bi·∫øn __app_id, __firebase_config, __initial_auth_token s·∫Ω kh√¥ng t·ªìn t·∫°i.
        // Game s·∫Ω t·ª± ƒë·ªông s·ª≠ d·ª•ng gi√° tr·ªã m·∫∑c ƒë·ªãnh/·∫©n danh.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { /* Th√™m c·∫•u h√¨nh Firebase c√¥ng khai c·ªßa b·∫°n ·ªü ƒë√¢y n·∫øu c·∫ßn */ };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = null;
        let highScoresRef = null;
        let currentHighScores = [];
        let isAuthReady = false;

        // --- Bi·∫øn Game ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('score');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const startButton = document.getElementById('startButton');
        const highScoresList = document.getElementById('highScoresList');
        const userInfoDisplay = document.getElementById('user-info');
        // Gemini API DOM elements
        const generateCommentaryButton = document.getElementById('generateCommentaryButton');
        const aiCommentaryDiv = document.getElementById('aiCommentary');
        const commentaryText = document.getElementById('commentaryText');
        const loadingIndicator = document.getElementById('loadingIndicator');


        const tileCount = 20; // S·ªë √¥ tr√™n m·ªói c·∫°nh (20x20 grid)
        const gridSize = canvas.width / tileCount; // K√≠ch th∆∞·ªõc m·ªói √¥
        let snake = [];
        let food = {};
        let dx = 0; // x velocity (t·ªëc ƒë·ªô theo tr·ª•c X)
        let dy = 0; // y velocity (t·ªëc ƒë·ªô theo tr·ª•c Y)
        let score = 0;
        let gameInterval;
        let gameSpeed = 150; // T·ªëc ƒë·ªô game ban ƒë·∫ßu (milliseconds)
        let isGameOver = true;
        let gameLocked = false; // NgƒÉn ch·∫∑n thay ƒë·ªïi h∆∞·ªõng li√™n t·ª•c

        // --- Ch·ª©c nƒÉng Firebase ---

        // 1. Kh·ªüi t·∫°o v√† ƒêƒÉng nh·∫≠p
        async function initializeFirebase() {
            if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                console.warn("Firebase config is missing or empty. High scores may not work outside of Canvas.");
                userInfoDisplay.textContent = 'Ch·∫ø ƒë·ªô ·∫©n danh (Kh√¥ng c√≥ B·∫£ng x·∫øp h·∫°ng)';
                isAuthReady = true;
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // ƒê∆∞·ªùng d·∫´n t·ªõi collection c√¥ng khai ƒë·ªÉ l∆∞u ƒêi·ªÉm Cao
                highScoresRef = collection(db, `artifacts/${appId}/public/data/snake_highscores`);

                // ƒêƒÉng nh·∫≠p b·∫±ng token t√πy ch·ªânh ho·∫∑c ·∫©n danh
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // L·∫Øng nghe thay ƒë·ªïi tr·∫°ng th√°i Auth
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userInfoDisplay.innerHTML = `Ng∆∞·ªùi ch∆°i: <span class="text-yellow-400 font-medium">${userId.substring(0, 8)}...</span>`;
                        isAuthReady = true;
                        loadHighScores(); // T·∫£i ƒëi·ªÉm cao khi Auth s·∫µn s√†ng
                    } else {
                        userId = null;
                        userInfoDisplay.textContent = 'Ng∆∞·ªùi ch∆°i ·∫©n danh (ƒêƒÉng nh·∫≠p ƒë·ªÉ l∆∞u ƒëi·ªÉm)';
                        isAuthReady = true;
                    }
                });

            } catch (error) {
                console.error("L·ªói khi kh·ªüi t·∫°o Firebase:", error);
                userInfoDisplay.textContent = 'L·ªói k·∫øt n·ªëi Firebase.';
            }
        }

        // 2. T·∫£i ƒêi·ªÉm Cao theo th·ªùi gian th·ª±c (onSnapshot)
        function loadHighScores() {
            if (!isAuthReady || !highScoresRef) return;

            // Truy v·∫•n l·∫•y d·ªØ li·ªáu. D√πng limit v√† sort client-side ƒë·ªÉ tr√°nh l·ªói index.
            const q = query(highScoresRef, limit(20));

            onSnapshot(q, (snapshot) => {
                const fetchedScores = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    fetchedScores.push({
                        id: doc.id,
                        score: data.score || 0,
                        username: data.username || `Ng∆∞·ªùi ch∆°i ${doc.id.substring(0, 4)}`,
                        timestamp: data.timestamp ? data.timestamp.toDate() : new Date(),
                        isCurrentUser: doc.id === userId
                    });
                });

                // S·∫Øp x·∫øp client-side: gi·∫£m d·∫ßn theo ƒëi·ªÉm, tƒÉng d·∫ßn theo th·ªùi gian (c√πng ƒëi·ªÉm)
                fetchedScores.sort((a, b) => {
                    if (b.score !== a.score) {
                        return b.score - a.score; // S·∫Øp x·∫øp theo ƒëi·ªÉm gi·∫£m d·∫ßn
                    }
                    return a.timestamp - b.timestamp; // S·∫Øp x·∫øp theo th·ªùi gian tƒÉng d·∫ßn
                });

                currentHighScores = fetchedScores.slice(0, 10); // Ch·ªâ gi·ªØ top 10

                renderHighScores(currentHighScores);
            }, (error) => {
                console.error("L·ªói t·∫£i ƒëi·ªÉm cao:", error);
                highScoresList.innerHTML = `<p class="text-center text-red-500">L·ªói: Kh√¥ng th·ªÉ t·∫£i ƒëi·ªÉm cao.</p>`;
            });
        }

        // 3. Hi·ªÉn th·ªã ƒêi·ªÉm Cao
        function renderHighScores(scores) {
            highScoresList.innerHTML = scores.map((item, index) => {
                const rank = index + 1;
                const baseClasses = "flex justify-between p-2 rounded-lg text-sm transition duration-150";
                const rankColor = rank === 1 ? 'text-yellow-400' : rank === 2 ? 'text-gray-300' : rank === 3 ? 'text-amber-600' : 'text-gray-300';
                const userHighlight = item.isCurrentUser ? 'bg-green-700 font-bold' : 'bg-gray-700';
                const rankSymbol = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : `#${rank}`;

                return `
                    <div class="${baseClasses} ${userHighlight}">
                        <span class="${rankColor} font-extrabold w-8">${rankSymbol}</span>
                        <span class="truncate flex-1 ml-2">${item.username.split(' ')[1] ? item.username.split(' ')[1] : item.username}</span>
                        <span class="font-mono text-lg text-right">${item.score}</span>
                    </div>
                `;
            }).join('');

            if (scores.length === 0) {
                 highScoresList.innerHTML = `<p class="text-center text-gray-400">Ch∆∞a c√≥ ƒëi·ªÉm cao n√†o. H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n!</p>`;
            }
        }

        // 4. L∆∞u ƒêi·ªÉm Cao C√° Nh√¢n
        async function saveHighScore(newScore) {
            if (!userId || !highScoresRef) {
                console.warn("Kh√¥ng th·ªÉ l∆∞u ƒëi·ªÉm: Ch∆∞a ƒëƒÉng nh·∫≠p ho·∫∑c Firebase ch∆∞a s·∫µn s√†ng.");
                return;
            }

            const userDocRef = doc(highScoresRef, userId);

            try {
                // L∆∞u ƒëi·ªÉm m·ªõi. merge: true ƒë·∫£m b·∫£o kh√¥ng ghi ƒë√® c√°c tr∆∞·ªùng kh√°c.
                // Firestore s·∫Ω t·ª± ƒë·ªông c·∫≠p nh·∫≠t n·∫øu ƒëi·ªÉm n√†y cao h∆°n ƒëi·ªÉm hi·ªán t·∫°i c·ªßa user.
                await setDoc(userDocRef, {
                    score: newScore,
                    username: `Player ${userId.substring(0, 4)}`,
                    userId: userId,
                    timestamp: serverTimestamp(),
                }, { merge: true });

                console.log(`ƒêi·ªÉm ${newScore} ƒë√£ ƒë∆∞·ª£c l∆∞u th√†nh c√¥ng cho user ${userId}`);
            } catch (e) {
                console.error("L·ªói khi l∆∞u ƒëi·ªÉm cao:", e);
            }
        }

        // --- Ch·ª©c nƒÉng Game ---

        function placeFood() {
            // ƒê·∫∑t th·ª©c ƒÉn ·ªü v·ªã tr√≠ ng·∫´u nhi√™n kh√¥ng tr√πng v·ªõi th√¢n r·∫Øn
            do {
                food.x = Math.floor(Math.random() * tileCount);
                food.y = Math.floor(Math.random() * tileCount);
            } while (snake.some(segment => segment.x === food.x && segment.y === food.y));
        }

        function startGame() {
            if (!isGameOver) return;

            // Reset game state
            snake = [{ x: Math.floor(tileCount / 2), y: Math.floor(tileCount / 2) }];
            dx = 1;
            dy = 0;
            score = 0;
            gameSpeed = 150;
            isGameOver = false;
            gameLocked = false;
            scoreDisplay.textContent = score;

            placeFood();

            messageBox.classList.add('hidden');
            startButton.textContent = 'ƒêang Ch∆°i...';
            startButton.disabled = true;

            // B·∫Øt ƒë·∫ßu v√≤ng l·∫∑p game
            clearInterval(gameInterval);
            gameInterval = setInterval(gameLoop, gameSpeed);
        }

        function gameLoop() {
            if (isGameOver) {
                clearInterval(gameInterval);
                return;
            }
            update();
            draw();
            gameLocked = false; // M·ªü kh√≥a cho ph√©p nh·∫≠n h∆∞·ªõng m·ªõi
        }

        function update() {
            // T·∫°o ƒë·∫ßu r·∫Øn m·ªõi
            const head = { x: snake[0].x + dx, y: snake[0].y + dy };

            // Ki·ªÉm tra va ch·∫°m (T∆∞·ªùng ho·∫∑c T·ª± th√¢n)
            if (checkCollision(head)) {
                gameOver();
                return;
            }

            // Th√™m ƒë·∫ßu r·∫Øn m·ªõi v√†o m·∫£ng
            snake.unshift(head);

            // Ki·ªÉm tra ƒÉn th·ª©c ƒÉn
            if (head.x === food.x && head.y === food.y) {
                score++;
                scoreDisplay.textContent = score;
                placeFood(); // ƒê·∫∑t th·ª©c ƒÉn m·ªõi

                // TƒÉng t·ªëc ƒë·ªô game sau m·ªói 5 ƒëi·ªÉm
                if (score % 5 === 0 && gameSpeed > 50) {
                    gameSpeed -= 10;
                    clearInterval(gameInterval);
                    gameInterval = setInterval(gameLoop, gameSpeed);
                }
            } else {
                // N·∫øu kh√¥ng ƒÉn, lo·∫°i b·ªè ƒëu√¥i (r·∫Øn di chuy·ªÉn)
                snake.pop();
            }
        }

        function checkCollision(head) {
            // Va ch·∫°m t∆∞·ªùng
            const wallCollision = head.x < 0 || head.x >= tileCount || head.y < 0 || head.y >= tileCount;
            // Va ch·∫°m th√¢n (b·ªè qua ƒë·∫ßu)
            const selfCollision = snake.slice(1).some(segment => segment.x === head.x && segment.y === head.y);

            return wallCollision || selfCollision;
        }

        function draw() {
            // X√≥a canvas
            ctx.fillStyle = '#2d3748';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // V·∫Ω r·∫Øn
            snake.forEach((segment, index) => {
                ctx.fillStyle = index === 0 ? '#68d391' : '#48bb78'; // ƒê·∫ßu r·∫Øn m√†u kh√°c
                ctx.fillRect(segment.x * gridSize, segment.y * gridSize, gridSize - 1, gridSize - 1);
            });

            // V·∫Ω th·ª©c ƒÉn
            ctx.fillStyle = '#f56565';
            ctx.beginPath();
            const centerX = food.x * gridSize + gridSize / 2;
            const centerY = food.y * gridSize + gridSize / 2;
            const radius = gridSize / 2;
            ctx.arc(centerX, centerY, radius - 2, 0, 2 * Math.PI);
            ctx.fill();
        }

        function gameOver() {
            isGameOver = true;
            clearInterval(gameInterval);
            startButton.textContent = 'Ch∆°i L·∫°i';
            startButton.disabled = false;

            messageText.innerHTML = `Game Over! ƒêi·ªÉm c·ªßa b·∫°n: <span class="text-yellow-400 font-extrabold">${score}</span>`;
            messageBox.classList.remove('hidden');

            // Hi·ªÉn th·ªã n√∫t b√¨nh lu·∫≠n AI v√† ƒë·∫∑t l·∫°i tr·∫°ng th√°i b√¨nh lu·∫≠n
            generateCommentaryButton.classList.remove('hidden');
            aiCommentaryDiv.classList.add('hidden');
            commentaryText.textContent = '';
            loadingIndicator.classList.add('hidden');

            // ƒê·∫∑t s·ª± ki·ªán cho n√∫t ƒë·ªÉ g·ªçi Gemini API
            generateCommentaryButton.onclick = () => generateCommentary(score);

            // L∆∞u ƒëi·ªÉm cao
            if (score > 0) {
                saveHighScore(score);
            }
        }

        // --- X·ª≠ l√Ω Input ---

        function handleKeydown(event) {
            // Cho ph√©p ph√≠m ENTER ƒë·ªÉ b·∫Øt ƒë·∫ßu game khi ƒëang ·ªü m√†n h√¨nh ch·ªù
            if (isGameOver && event.key === 'Enter') {
                startGame();
                return;
            }

            if (isGameOver || gameLocked) return;

            const keyPressed = event.key;
            let newDx = dx;
            let newDy = dy;

            switch (keyPressed) {
                case 'ArrowUp':
                case 'w':
                case 'W':
                    if (dy === 0) { newDx = 0; newDy = -1; }
                    break;
                case 'ArrowDown':
                case 's':
                case 'S':
                    if (dy === 0) { newDx = 0; newDy = 1; }
                    break;
                case 'ArrowLeft':
                case 'a':
                case 'A':
                    if (dx === 0) { newDx = -1; newDy = 0; }
                    break;
                case 'ArrowRight':
                case 'd':
                case 'D':
                    if (dx === 0) { newDx = 1; newDy = 0; }
                    break;
                default:
                    return; // B·ªè qua c√°c ph√≠m kh√°c
            }

            // Ch·ªâ cho ph√©p thay ƒë·ªïi h∆∞·ªõng n·∫øu h∆∞·ªõng m·ªõi kh√¥ng ƒë·ªëi di·ªán h∆∞·ªõng hi·ªán t·∫°i
            if (newDx !== -dx || newDy !== -dy) {
                dx = newDx;
                dy = newDy;
                gameLocked = true; // Kh√≥a input cho ƒë·∫øn frame ti·∫øp theo
            }
        }

        // --- Ch·ª©c nƒÉng Gemini API ---

        const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent";
        const apiKey = ""; // Canvas s·∫Ω t·ª± ƒë·ªông cung c·∫•p kh√≥a API.

        async function generateCommentary(finalScore) {
            generateCommentaryButton.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');
            aiCommentaryDiv.classList.add('hidden');
            commentaryText.textContent = '';

            const systemPrompt = "B·∫°n l√† m·ªôt b√¨nh lu·∫≠n vi√™n th·ªÉ thao chuy√™n nghi·ªáp v√† h√†i h∆∞·ªõc cho tr√≤ ch∆°i R·∫Øn SƒÉn M·ªìi. H√£y ƒë∆∞a ra m·ªôt b√¨nh lu·∫≠n ng·∫Øn g·ªçn (t·ªëi ƒëa 2 c√¢u) v·ªÅ ƒëi·ªÉm s·ªë cu·ªëi c√πng c·ªßa ng∆∞·ªùi ch∆°i. T√πy thu·ªôc v√†o ƒëi·ªÉm s·ªë, b√¨nh lu·∫≠n c√≥ th·ªÉ l√†: k·ªãch t√≠nh, ch·∫ø gi·ªÖu nh·∫π nh√†ng, kh√≠ch l·ªá, ho·∫∑c c·ª±c k·ª≥ ca ng·ª£i. Ch·ªâ tr·∫£ l·ªùi b·∫±ng ti·∫øng Vi·ªát.";
            const userQuery = `Ng∆∞·ªùi ch∆°i ƒë√£ ƒë·∫°t ƒë∆∞·ª£c ${finalScore} ƒëi·ªÉm. H√£y b√¨nh lu·∫≠n v·ªÅ m√†n tr√¨nh di·ªÖn n√†y.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            const maxRetries = 5;
            let delay = 1000; // 1 second
            let responseText = "L·ªói: Kh√¥ng th·ªÉ nh·∫≠n b√¨nh lu·∫≠n t·ª´ AI.";

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(`${GEMINI_API_URL}?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && i < maxRetries - 1) {
                            // Qu√° nhi·ªÅu y√™u c·∫ßu, th·ª≠ l·∫°i
                            await new Promise(resolve => setTimeout(resolve, delay));
                            delay *= 2; // TƒÉng d·∫ßn th·ªùi gian ch·ªù
                            continue;
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (text) {
                        responseText = text;
                        break; // Th√†nh c√¥ng
                    }
                } catch (error) {
                    console.error("L·ªói API Gemini:", error);
                }

                if (i < maxRetries - 1) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }

            loadingIndicator.classList.add('hidden');
            aiCommentaryDiv.classList.remove('hidden');
            commentaryText.textContent = responseText;
        }

        // --- Kh·ªüi t·∫°o ---

        window.onload = function () {
            // K√≠ch ho·∫°t Firebase v√† Auth
            initializeFirebase();

            // ƒê·∫∑t s·ª± ki·ªán cho n√∫t Start
            startButton.addEventListener('click', startGame);

            // ƒê·∫∑t s·ª± ki·ªán l·∫Øng nghe ph√≠m
            document.addEventListener('keydown', handleKeydown);

            // V·∫Ω l·∫ßn ƒë·∫ßu ti√™n ƒë·ªÉ hi·ªÉn th·ªã m√†n h√¨nh ch·ªù
            draw();
            messageBox.classList.remove('hidden');
            // C·∫≠p nh·∫≠t th√¥ng b√°o: Th√™m ph√≠m ENTER
            messageText.textContent = 'Nh·∫•n B·∫ÆT ƒê·∫¶U ho·∫∑c ph√≠m ENTER ƒë·ªÉ ch∆°i! Sau ƒë√≥ d√πng c√°c ph√≠m m≈©i t√™n ho·∫∑c WASD ƒë·ªÉ ƒëi·ªÅu khi·ªÉn.';
        };
    </script>
</body>
</html>

